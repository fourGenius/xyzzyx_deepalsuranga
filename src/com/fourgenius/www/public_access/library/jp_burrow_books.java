/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.fourgenius.www.public_access.library;

import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import javax.swing.JOptionPane;
import public_access.MC_JavaDataBaseConnection;

/**
 *
 * @author Dineth Jayasekera
 */
public class jp_burrow_books extends javax.swing.JPanel {

    /**
     * Creates new form jp_burrow_books
     */
    public jp_burrow_books() {
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jTextField1 = new javax.swing.JTextField();
        jTextField2 = new javax.swing.JTextField();
        jButton1 = new javax.swing.JButton();
        jButton2 = new javax.swing.JButton();

        setBackground(new java.awt.Color(2, 119, 189));

        jLabel1.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        jLabel1.setForeground(new java.awt.Color(255, 255, 255));
        jLabel1.setText("Member ID");

        jLabel2.setFont(new java.awt.Font("Tahoma", 0, 14)); // NOI18N
        jLabel2.setForeground(new java.awt.Color(255, 255, 255));
        jLabel2.setText("Book ID");

        jButton1.setText("Submit");
        jButton1.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButton1ActionPerformed(evt);
            }
        });

        jButton2.setText("Cencel");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(290, 290, 290)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel1)
                            .addComponent(jLabel2))
                        .addGap(18, 18, 18)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(jTextField1)
                            .addComponent(jTextField2, javax.swing.GroupLayout.DEFAULT_SIZE, 295, Short.MAX_VALUE)))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(311, 311, 311)
                        .addComponent(jButton1)
                        .addGap(176, 176, 176)
                        .addComponent(jButton2)))
                .addContainerGap(696, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(202, 202, 202)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(jTextField1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(50, 50, 50)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(jTextField2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(82, 82, 82)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jButton1)
                    .addComponent(jButton2))
                .addContainerGap(371, Short.MAX_VALUE))
        );
    }// </editor-fold>//GEN-END:initComponents

    private void jButton1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButton1ActionPerformed

        
        // TODO add your handling code here:
        //assign the memberid and bookid to string array
        String info[] =new String[2];
        info[0] = jTextField1.getText();
        info[1] = jTextField2.getText();
        //check if fields are empty
        if(info[0].equals("") || info[1].equals("")){
            JOptionPane.showMessageDialog(this, "Fill all the text fieldes", "ERROR", JOptionPane.ERROR_MESSAGE);
        }
        else{
            try{
                //check if there is a fine to be paid by the user 
                ResultSet rs= MC_JavaDataBaseConnection.myConnection().createStatement().executeQuery("SELECT * FROM lib_payment WHERE MID='"+info[0]+"' AND status='Not Paid'");
                if(rs.next()){
                     JOptionPane.showMessageDialog(this, "Fine is there to be payed", "Error", JOptionPane.ERROR_MESSAGE);
                     //pass the string array with member id and book id to the Fine pay GUI's main method
//                     Fine_Pay.main(info);                 
                }
                else{
                    //get todays date
                    Date today = new Date();
                    DateFormat df = new SimpleDateFormat("yyyy/MM/dd");
                    Date dueDate = new Date();
                    //assign due date due with present date +7 days
                    Calendar cal = Calendar.getInstance();
                    cal.setTime(dueDate);
                    cal.add(Calendar.DATE,7);
                    dueDate = cal.getTime();
                    //insert the details of the book borrowed to borrowed table
                    String query = "INSERT INTO lib_borrowed VALUES('"+info[1]+"','"+info[0]+"','"+df.format(today)+"','"+df.format(dueDate)+"')";
                    MC_JavaDataBaseConnection.myConnection().createStatement().executeUpdate(query);
                    //update the book to borrowed in book table
                    String query2 ="UPDATE lib_book SET Availability='Borrowed' WHERE BID='"+info[1]+"'";
                   MC_JavaDataBaseConnection.myConnection().createStatement().executeUpdate(query2);
                
                    JOptionPane.showMessageDialog(this, "Successfully updated", "", JOptionPane.INFORMATION_MESSAGE);
                }
                MC_JavaDataBaseConnection.myConnection().close();
            } 
            catch (Exception ex) {
              ex.printStackTrace();
                JOptionPane.showMessageDialog(this, "Error occured please check the inputs ", "ERROR", JOptionPane.ERROR_MESSAGE);
            }
        }
        
    }//GEN-LAST:event_jButton1ActionPerformed


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButton1;
    private javax.swing.JButton jButton2;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JTextField jTextField1;
    private javax.swing.JTextField jTextField2;
    // End of variables declaration//GEN-END:variables
}
